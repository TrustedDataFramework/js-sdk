<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script src="./dist/bundle.js"></script>
    <script>
        async function main() {
            const sk = tdsSDK.generatePrivateKey()
            const addr = tdsSDK.publicKey2Address(tdsSDK.privateKey2PublicKey(sk))
            const rpc = new tdsSDK.RPC('120.76.101.153', 7010)
            const n = (await rpc.getNonce(addr)) + 1
            const bd = new tdsSDK.TransactionBuilder(tdsSDK.constants.POA_VERSION, sk, 0, 0, n)
            let contractAddr = localStorage.getItem('contract-address')
            let abi = await (await fetch('./local/registerdapp.abi.json')).arrayBuffer()
            abi = JSON.parse(tdsSDK.bin2str(abi))
            const c = new tdsSDK.Contract('', abi)

            if (!contractAddr) {
                let resp = await fetch('./local/registerdapp.wasm')
                const buf = await resp.arrayBuffer()
                c.binary = tdsSDK.hex2bin(buf)
                let tx = bd.buildDeploy(c)
                resp = await rpc.sendAndObserve(tx)
                console.log('登记合约已部署')
                localStorage.setItem('contract-address', tdsSDK.getContractAddress(addr, n))
                c.address = tdsSDK.getContractAddress(addr, n)
            } else {
                c.address = contractAddr
            }
            // 多人同时登记
            // for(let i = 0; i < 10; i++){
            //     bd.sk = tdsSDK.generatePrivateKey()
            //     bd.nonce = 1
            //     let tx = bd.buildContractCall(c, 'saveRegister', ['username', 'man', Date.now(), '12345678'])
            //     rpc.sendAndObserve(tx).then(console.log('成功登记'))
            // }
        }



        main()
    </script>
</body>

</html>